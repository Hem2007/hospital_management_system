<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bed Management â€” MediTrack</title>
  <link rel="stylesheet" href="../css/dashboard.css">
  <script src="../js/data.js"></script>
</head>
<body>
  <aside class="sidebar">
    <div class="sidebar-logo">
      <div class="logo-icon">ğŸ¥</div>
      <h2>MediTrack</h2>
      <p>Admin Control Panel</p>
    </div>
    <div class="nav-section">
      <div class="nav-label">Main</div>
      <a class="nav-item" href="admin.html"><span class="icon">ğŸ“Š</span> Dashboard</a>
      <a class="nav-item active" href="beds.html"><span class="icon">ğŸ›ï¸</span> Bed Management</a>
      <a class="nav-item" href="patients.html"><span class="icon">ğŸ‘¥</span> Patients</a>
      <a class="nav-item" href="prediction.html"><span class="icon">ğŸ“ˆ</span> Predictions</a>
    </div>
    <div class="nav-section">
      <div class="nav-label">Admin</div>
      <a class="nav-item" href="manage-users.html"><span class="icon">ğŸ”§</span> Manage Users</a>
      <a class="nav-item" href="reports.html"><span class="icon">ğŸ“‹</span> Reports</a>
      <a class="nav-item" href="alerts.html"><span class="icon">ğŸ””</span> Alerts</a>
    </div>
    <div class="sidebar-footer">
      <div class="user-chip">
        <div class="user-avatar" id="user-avatar">A</div>
        <div class="user-info">
          <div class="user-name" id="user-name">Admin</div>
          <div class="user-role">Administrator</div>
        </div>
        <button class="logout-btn" onclick="logout()">â»</button>
      </div>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div>
        <h1>Bed Management</h1>
        <div class="subtitle">Update occupancy and bed status across all wards</div>
      </div>
      <div class="topbar-actions">
        <button class="btn btn-primary" onclick="openAddBedModal()">+ Add Beds</button>
      </div>
    </div>

    <!-- Summary -->
    <div class="cards-grid" id="stat-cards"></div>

    <!-- Bed editor table -->
    <div class="section">
      <div class="section-header">
        <div class="section-title">ğŸ›ï¸ Ward Bed Status</div>
        <button class="btn btn-success" onclick="saveAll()">ğŸ’¾ Save All Changes</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Ward</th>
              <th>Total Beds</th>
              <th>Occupied</th>
              <th>Maintenance</th>
              <th>Available</th>
              <th>Occupancy</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="bed-table-body"></tbody>
        </table>
      </div>
    </div>

    <!-- Individual bed grid visual -->
    <div class="section">
      <div class="section-header">
        <div class="section-title">ğŸ“ Bed Grid â€” <select class="input" id="ward-select" onchange="renderGrid()" style="padding:4px 10px;font-size:13px"></select></div>
        <div style="display:flex;gap:12px;align-items:center;font-size:12px;color:var(--silver)">
          <span style="color:var(--emerald)">â–  Available</span>
          <span style="color:var(--amber)">â–  Occupied</span>
          <span style="color:var(--red)">â–  Maintenance</span>
        </div>
      </div>
      <div id="bed-grid" style="display:flex;flex-wrap:wrap;gap:8px;padding-top:4px"></div>
    </div>
  </main>

  <!-- Add beds modal -->
  <div class="modal-overlay" id="add-modal">
    <div class="modal">
      <h3>â• Add / Update Beds</h3>
      <div class="form-group" style="margin-bottom:16px">
        <label style="font-size:12px;color:var(--silver);text-transform:uppercase;letter-spacing:.05em;display:block;margin-bottom:6px">Ward</label>
        <select class="input" id="modal-ward" style="width:100%">
          <!-- filled by JS -->
        </select>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px">
        <div>
          <label style="font-size:12px;color:var(--silver);text-transform:uppercase;letter-spacing:.05em;display:block;margin-bottom:6px">Occupied (+/-)</label>
          <input class="input" type="number" id="modal-occupied" placeholder="e.g. 5" style="width:100%">
        </div>
        <div>
          <label style="font-size:12px;color:var(--silver);text-transform:uppercase;letter-spacing:.05em;display:block;margin-bottom:6px">Maintenance (+/-)</label>
          <input class="input" type="number" id="modal-maint" placeholder="e.g. 2" style="width:100%">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="applyModal()">Apply</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const user = getUser();
    if (user.role !== 'admin') window.location.href = 'dashboard.html';
    document.getElementById('user-name').textContent = user.username;
    document.getElementById('user-avatar').textContent = user.username[0].toUpperCase();

    let state = getState();

    function computeTotals() {
      let tB=0,tO=0,tM=0;
      Object.values(state.beds).forEach(b=>{tB+=b.total;tO+=b.occupied;tM+=b.maintenance;});
      return {tB,tO,tM,tA:tB-tO-tM};
    }

    function renderStats() {
      const {tB,tO,tM,tA} = computeTotals();
      document.getElementById('stat-cards').innerHTML = [
        {label:'Total Beds',value:tB,icon:'ğŸ›ï¸',color:'var(--blue-l)'},
        {label:'Available', value:tA, icon:'âœ…', color:'var(--emerald)'},
        {label:'Occupied',  value:tO, icon:'ğŸ‘¤', color:'var(--amber)'},
        {label:'Maintenance',value:tM,icon:'ğŸ”§',color:'var(--silver)'},
      ].map(s=>`
        <div class="stat-card">
          <div class="sc-label">${s.icon} ${s.label}</div>
          <div class="sc-value" style="color:${s.color}">${s.value}</div>
        </div>
      `).join('');
    }

    function renderTable() {
      document.getElementById('bed-table-body').innerHTML = WARDS.map(w=>{
        const b = state.beds[w.id];
        const avail = b.total - b.occupied - b.maintenance;
        const rate = Math.round((b.occupied/b.total)*100);
        const fillColor = rate>85?'var(--red)':rate>70?'var(--amber)':'var(--emerald)';
        return `
          <tr>
            <td><b>${w.icon} ${w.name}</b></td>
            <td><input class="input" type="number" min="0" value="${b.total}" 
              onchange="updateBed('${w.id}','total',this.value)" style="width:70px;padding:6px 8px"></td>
            <td><input class="input" type="number" min="0" value="${b.occupied}" 
              onchange="updateBed('${w.id}','occupied',this.value)" style="width:70px;padding:6px 8px"></td>
            <td><input class="input" type="number" min="0" value="${b.maintenance}" 
              onchange="updateBed('${w.id}','maintenance',this.value)" style="width:70px;padding:6px 8px"></td>
            <td style="color:var(--emerald);font-weight:600">${Math.max(0,avail)}</td>
            <td>
              <div style="display:flex;align-items:center;gap:8px">
                <div class="progress-bar" style="width:80px">
                  <div class="progress-fill" style="width:${rate}%;background:${fillColor}"></div>
                </div>
                <span style="font-size:12px;color:${fillColor}">${rate}%</span>
              </div>
            </td>
            <td>
              <button class="btn btn-ghost" style="padding:5px 12px;font-size:12px" 
                onclick="document.getElementById('ward-select').value='${w.id}';renderGrid()">View Grid</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function updateBed(wardId, field, val) {
      state.beds[wardId][field] = Math.max(0, parseInt(val)||0);
      const b = state.beds[wardId];
      if(b.occupied + b.maintenance > b.total) {
        b.occupied = Math.max(0, b.total - b.maintenance);
      }
      renderStats();
    }

    function saveAll() {
      saveState(state);
      showToast('âœ… All changes saved successfully!','success');
    }

    // Ward select
    const ws = document.getElementById('ward-select');
    WARDS.forEach(w => {
      const o = document.createElement('option');
      o.value = w.id; o.textContent = w.icon+' '+w.name;
      ws.appendChild(o);
    });

    function renderGrid() {
      const wardId = document.getElementById('ward-select').value;
      const w = WARDS.find(x=>x.id===wardId);
      const b = state.beds[wardId];
      const grid = document.getElementById('bed-grid');
      let html = '';
      for(let i=1;i<=b.total;i++){
        const isOcc = i <= b.occupied;
        const isMaint = !isOcc && i <= b.occupied + b.maintenance;
        const color = isOcc ? 'var(--amber)' : isMaint ? 'var(--red)' : 'var(--emerald)';
        const label = isOcc ? 'Occupied' : isMaint ? 'Maintenance' : 'Free';
        html += `<div title="Bed ${i} â€” ${label}" style="
          width:40px;height:40px;border-radius:8px;
          background:${color}22;border:1.5px solid ${color};
          display:flex;align-items:center;justify-content:center;
          font-size:11px;font-weight:600;color:${color};cursor:pointer;
          transition:transform .15s
        " onmouseenter="this.style.transform='scale(1.1)'" onmouseleave="this.style.transform='scale(1)'">${i}</div>`;
      }
      grid.innerHTML = html;
    }

    // Modal
    function openAddBedModal() {
      const mw = document.getElementById('modal-ward');
      mw.innerHTML = '';
      WARDS.forEach(w=>{
        const o=document.createElement('option'); o.value=w.id; o.textContent=w.name; mw.appendChild(o);
      });
      document.getElementById('add-modal').classList.add('open');
    }
    function closeModal() { document.getElementById('add-modal').classList.remove('open'); }
    function applyModal() {
      const wid = document.getElementById('modal-ward').value;
      const occ = parseInt(document.getElementById('modal-occupied').value)||0;
      const mnt = parseInt(document.getElementById('modal-maint').value)||0;
      state.beds[wid].occupied = Math.min(state.beds[wid].total, Math.max(0, state.beds[wid].occupied + occ));
      state.beds[wid].maintenance = Math.min(state.beds[wid].total - state.beds[wid].occupied, Math.max(0, state.beds[wid].maintenance + mnt));
      closeModal();
      renderTable(); renderStats(); renderGrid();
      showToast('âœ… Bed counts updated!','success');
    }

    function showToast(msg,type='success') {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.className = `toast ${type} show`;
      setTimeout(()=>t.classList.remove('show'),3000);
    }

    renderStats(); renderTable(); renderGrid();
  </script>
</body>
</html>
