<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Staff Dashboard â€” MediTrack</title>
  <link rel="stylesheet" href="../css/dashboard.css">
  <script src="../js/data.js"></script>
</head>
<body>
  <aside class="sidebar">
    <div class="sidebar-logo">
      <div class="logo-icon">ğŸ¥</div>
      <h2>MediTrack</h2>
      <p>Staff Portal</p>
    </div>
    <div class="nav-section">
      <div class="nav-label">Main</div>
      <a class="nav-item active" href="dashboard.html"><span class="icon">ğŸ“Š</span> Dashboard</a>
      <a class="nav-item" href="patients.html"><span class="icon">ğŸ‘¥</span> Patients</a>
      <a class="nav-item" href="prediction.html"><span class="icon">ğŸ“ˆ</span> Predictions</a>
    </div>
    <div class="sidebar-footer">
      <div class="user-chip">
        <div class="user-avatar" id="user-avatar">U</div>
        <div class="user-info">
          <div class="user-name" id="user-name">User</div>
          <div class="user-role">Staff / Viewer</div>
        </div>
        <button class="logout-btn" onclick="logout()">â»</button>
      </div>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div>
        <h1>Bed Availability</h1>
        <div class="subtitle" id="datestr"></div>
      </div>
      <div class="topbar-actions">
        <span style="font-size:12px;color:var(--silver);background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3);padding:6px 12px;border-radius:8px">ğŸ‘ View Only Mode</span>
      </div>
    </div>

    <!-- Stats -->
    <div class="cards-grid" id="stat-cards"></div>

    <!-- Real-time beds view -->
    <div class="section" style="margin-bottom:24px">
      <div class="section-header">
        <div class="section-title">ğŸ¥ Real-Time Ward Status</div>
        <button class="btn btn-ghost" style="font-size:12px" onclick="refresh()">â†» Refresh</button>
      </div>
      <div class="wards-grid" id="wards-grid"></div>
    </div>

    <!-- Quick prediction peek -->
    <div class="section">
      <div class="section-header">
        <div class="section-title">ğŸ“ˆ Tomorrow's Forecast (All Wards)</div>
        <button class="section-action" onclick="window.location.href='prediction.html'">Full Report â†’</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr><th>Ward</th><th>Current Rate</th><th>Tomorrow (est)</th><th>Available Tomorrow</th><th>Risk</th></tr>
          </thead>
          <tbody id="forecast-body"></tbody>
        </table>
      </div>
    </div>
  </main>

  <script>
    const user = getUser();
    if(user.role !== 'user') window.location.href = 'admin.html';
    document.getElementById('user-name').textContent = user.username;
    document.getElementById('user-avatar').textContent = user.username[0].toUpperCase();
    document.getElementById('datestr').textContent = new Date().toLocaleDateString('en',{weekday:'long',year:'numeric',month:'long',day:'numeric'});

    function refresh() {
      const state = getState();
      render(state);
    }

    function render(state) {
      const beds = state.beds;
      let tB=0,tO=0,tA=0;
      Object.values(beds).forEach(b=>{tB+=b.total;tO+=b.occupied;tA+=b.total-b.occupied-b.maintenance;});
      const rate = Math.round((tO/tB)*100);

      document.getElementById('stat-cards').innerHTML = [
        {label:'Total Beds',value:tB,icon:'ğŸ›ï¸',color:'var(--blue-l)'},
        {label:'Available Now',value:tA,icon:'âœ…',color:'var(--emerald)'},
        {label:'Occupied',value:tO,icon:'ğŸ‘¤',color:'var(--amber)'},
        {label:'Occupancy',value:rate+'%',icon:'ğŸ“Š',color:rate>85?'var(--red)':rate>70?'var(--amber)':'var(--emerald)'},
      ].map(s=>`
        <div class="stat-card">
          <div class="sc-label">${s.icon} ${s.label}</div>
          <div class="sc-value" style="color:${s.color}">${s.value}</div>
        </div>
      `).join('');

      document.getElementById('wards-grid').innerHTML = WARDS.map(w=>{
        const b = beds[w.id];
        const avail = b.total - b.occupied - b.maintenance;
        const rate2 = Math.round((b.occupied/b.total)*100);
        const badgeCls = rate2>85?'badge-crit':rate2>70?'badge-warn':'badge-ok';
        const badgeTxt = rate2>85?'Critical':rate2>70?'High':'Good';
        const fillColor = rate2>85?'var(--red)':rate2>70?'var(--amber)':'var(--emerald)';
        return `
          <div class="ward-card">
            <div class="ward-header">
              <div class="ward-title">${w.icon} ${w.name}</div>
              <span class="ward-badge ${badgeCls}">${badgeTxt}</span>
            </div>
            <div class="ward-numbers">
              <div class="wn-item"><div class="wn-val" style="color:var(--emerald)">${avail}</div><div class="wn-lbl">Free</div></div>
              <div class="wn-item"><div class="wn-val" style="color:var(--amber)">${b.occupied}</div><div class="wn-lbl">Occupied</div></div>
              <div class="wn-item"><div class="wn-val">${b.total}</div><div class="wn-lbl">Total</div></div>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width:${rate2}%;background:${fillColor}"></div>
            </div>
          </div>
        `;
      }).join('');

      // Forecast table
      document.getElementById('forecast-body').innerHTML = WARDS.map(w=>{
        const b = beds[w.id];
        const currRate = Math.round((b.occupied/b.total)*100);
        const preds = predict(w.id, 1);
        const p = preds[0];
        const avail = p.total - p.predicted;
        const c = p.rate>=90?'var(--red)':p.rate>=75?'var(--amber)':p.rate>=60?'var(--blue-l)':'var(--emerald)';
        const risk = p.rate>=90?'Critical':p.rate>=75?'High':p.rate>=60?'Moderate':'Low';
        return `<tr>
          <td><b>${w.icon} ${w.name}</b></td>
          <td>${currRate}%</td>
          <td style="color:${c};font-weight:600">${p.rate}%</td>
          <td style="color:var(--emerald)">${avail} beds</td>
          <td><span class="condition-badge" style="background:${c}22;color:${c}">${risk}</span></td>
        </tr>`;
      }).join('');
    }

    render(getState());
  </script>
</body>
</html>
