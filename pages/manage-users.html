<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Users â€” MediTrack</title>
  <link rel="stylesheet" href="../css/dashboard.css">
  <script src="../js/data.js"></script>
</head>
<body>

  <aside class="sidebar">
    <div class="sidebar-logo">
      <div class="logo-icon">ğŸ¥</div>
      <h2>MediTrack</h2>
      <p>Admin Control Panel</p>
    </div>

    <div class="nav-section">
      <div class="nav-label">Main</div>
      <a class="nav-item" href="admin.html">ğŸ“Š Dashboard</a>
      <a class="nav-item" href="beds.html">ğŸ›ï¸ Bed Management</a>
      <a class="nav-item" href="patients.html">ğŸ‘¥ Patients</a>
      <a class="nav-item" href="prediction.html">ğŸ“ˆ Predictions</a>
    </div>

    <div class="nav-section">
      <div class="nav-label">Admin</div>
      <a class="nav-item active" href="manage-users.html">ğŸ”§ Manage Users</a>
      <a class="nav-item" href="reports.html">ğŸ“‹ Reports</a>
      <a class="nav-item" href="alerts.html">ğŸ”” Alerts</a>
    </div>

    <div class="sidebar-footer">
      <div class="user-chip">
        <div class="user-avatar" id="user-avatar">A</div>
        <div class="user-info">
          <div class="user-name" id="user-name">Admin</div>
          <div class="user-role">Administrator</div>
        </div>
        <button class="logout-btn" onclick="logout()">â»</button>
      </div>
    </div>
  </aside>

  <main class="main">

    <div class="topbar">
      <div>
        <h1>User Management</h1>
        <div class="subtitle">Manage system accounts and privileges</div>
      </div>
      <button class="btn btn-primary" onclick="openModal()">+ Add User</button>
    </div>

    <!-- PRIVILEGE MATRIX -->
    <div class="section" style="margin-bottom:24px">
      <div class="section-header">
        <div class="section-title">ğŸ” Privilege Matrix</div>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Feature</th>
              <th>Administrator</th>
              <th>Staff / Viewer</th>
            </tr>
          </thead>
          <tbody id="privilege-body"></tbody>
        </table>
      </div>
    </div>

    <!-- USER TABLE -->
    <div class="section">
      <div class="section-header">
        <div class="section-title">ğŸ‘¤ System Users</div>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Username</th>
              <th>Role</th>
              <th>Status</th>
              <th>Last Login</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="users-body"></tbody>
        </table>
      </div>
    </div>

  </main>

  <!-- ADD USER MODAL -->
  <div class="modal-overlay" id="add-modal">
    <div class="modal">
      <h3>â• Add New User</h3>

      <div style="display:flex;flex-direction:column;gap:14px">

        <div>
          <label>Username</label>
          <input class="input" id="m-username" placeholder="e.g. dr_patel">
        </div>

        <div>
          <label>Password</label>
          <input class="input" type="password" id="m-password" placeholder="Password">
        </div>

        <div>
          <label>Role</label>
          <select class="input" id="m-role">
            <option value="user">Staff / Viewer</option>
            <option value="admin">Administrator</option>
          </select>
        </div>

      </div>

      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="addUser()">Create User</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>

  // CHECK ADMIN ACCESS
  const user = getUser();
  if (!user || user.role !== 'admin') {
    window.location.href = 'dashboard.html';
  }

  document.getElementById('user-name').textContent = user.username;
  document.getElementById('user-avatar').textContent =
    user.username[0].toUpperCase();

  /* ==========================
     PRIVILEGE MATRIX
  =========================== */

  const privRows = [
    ['View Dashboard','âœ…','âœ…'],
    ['View Bed Availability','âœ…','âœ…'],
    ['View Patients','âœ…','âœ…'],
    ['View Predictions','âœ…','âœ…'],
    ['Update Bed Counts','âœ…','âŒ'],
    ['Admit Patients','âœ…','âŒ'],
    ['Discharge Patients','âœ…','âŒ'],
    ['Manage Alerts','âœ…','âŒ'],
    ['Manage Users','âœ…','âŒ'],
    ['Generate Reports','âœ…','âŒ'],
  ];

  function renderPrivileges() {
    document.getElementById('privilege-body').innerHTML =
      privRows.map(([feature, admin, user]) => `
        <tr>
          <td style="font-weight:500">${feature}</td>
          <td style="text-align:center">${admin}</td>
          <td style="text-align:center">${user}</td>
        </tr>
      `).join('');
  }

  renderPrivileges();

  /* ==========================
     USER MANAGEMENT
  =========================== */

  let sysUsers =
    JSON.parse(sessionStorage.getItem('mt_sysusers')) || [
      {id:1, username:'admin', role:'admin', status:'Active', lastLogin:'Just now'},
      {id:2, username:'user', role:'user', status:'Active', lastLogin:'1 hour ago'},
      {id:3, username:'staff', role:'user', status:'Active', lastLogin:'3 hours ago'}
    ];

  function saveUsers() {
    sessionStorage.setItem('mt_sysusers', JSON.stringify(sysUsers));
  }

  function renderUsers() {
    document.getElementById('users-body').innerHTML =
      sysUsers.map(u => {

        const roleLabel =
          u.role === 'admin' ? 'Administrator' : 'Staff / Viewer';

        const canDelete = u.username !== 'admin';

        return `
          <tr>
            <td>
              <strong>${u.username}</strong>
            </td>
            <td>${roleLabel}</td>
            <td style="color:green">â— ${u.status}</td>
            <td>${u.lastLogin}</td>
            <td>
              ${canDelete
                ? `<button class="btn btn-danger"
                     onclick="deleteUser(${u.id})">
                     Remove
                   </button>`
                : `<span style="color:gray">Protected</span>`
              }
            </td>
          </tr>
        `;
      }).join('');
  }

  renderUsers();

  function deleteUser(id) {
    if (!confirm('Remove this user?')) return;

    sysUsers = sysUsers.filter(u => u.id !== id);
    saveUsers();
    renderUsers();
    showToast('User removed');
  }

  function openModal() {
    document.getElementById('add-modal').classList.add('open');
  }

  function closeModal() {
    document.getElementById('add-modal').classList.remove('open');
  }

  function addUser() {
    const username =
      document.getElementById('m-username').value.trim();

    const password =
      document.getElementById('m-password').value.trim();

    const role =
      document.getElementById('m-role').value;

    if (!username || !password) {
      showToast('Please fill all fields');
      return;
    }

    if (sysUsers.find(u => u.username === username)) {
      showToast('Username already exists');
      return;
    }

    const newId =
      sysUsers.length
        ? Math.max(...sysUsers.map(u => u.id)) + 1
        : 1;

    sysUsers.push({
      id: newId,
      username,
      role,
      status: 'Active',
      lastLogin: 'Never'
    });

    saveUsers();
    closeModal();
    renderUsers();
    showToast('User created: ' + username);
  }

  function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3000);
  }

</script>

</body>
</html>