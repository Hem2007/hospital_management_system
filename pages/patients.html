<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Patients â€” MediTrack</title>
  <link rel="stylesheet" href="../css/dashboard.css">
  <script src="../js/data.js"></script>
</head>
<body>
  <aside class="sidebar">
    <div class="sidebar-logo">
      <div class="logo-icon">ğŸ¥</div>
      <h2>MediTrack</h2>
      <p id="panel-label">Control Panel</p>
    </div>
    <div class="nav-section">
      <div class="nav-label">Main</div>
      <a class="nav-item" id="nav-home"><span class="icon">ğŸ“Š</span> Dashboard</a>
      <a class="nav-item" id="nav-beds"><span class="icon">ğŸ›ï¸</span> Bed Management</a>
      <a class="nav-item active" href="patients.html"><span class="icon">ğŸ‘¥</span> Patients</a>
      <a class="nav-item" href="prediction.html"><span class="icon">ğŸ“ˆ</span> Predictions</a>
    </div>
    <div class="nav-section" id="admin-links">
      <div class="nav-label">Admin</div>
      <a class="nav-item" href="manage-users.html"><span class="icon">ğŸ”§</span> Manage Users</a>
      <a class="nav-item" href="reports.html"><span class="icon">ğŸ“‹</span> Reports</a>
      <a class="nav-item" href="alerts.html"><span class="icon">ğŸ””</span> Alerts</a>
    </div>
    <div class="sidebar-footer">
      <div class="user-chip">
        <div class="user-avatar" id="user-avatar">U</div>
        <div class="user-info">
          <div class="user-name" id="user-name">User</div>
          <div class="user-role" id="user-role-label">Staff</div>
        </div>
        <button class="logout-btn" onclick="logout()">â»</button>
      </div>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div>
        <h1>Patient Records</h1>
        <div class="subtitle">View all current admissions</div>
      </div>
      <div class="topbar-actions" id="admin-actions" style="display:none">
        <button class="btn btn-primary" onclick="openAddModal()">+ Admit Patient</button>
      </div>
    </div>

    <!-- Filters -->
    <div style="display:flex;gap:12px;margin-bottom:24px;flex-wrap:wrap">
      <input class="input" id="search" placeholder="ğŸ” Search patient..." oninput="renderTable()" style="min-width:220px">
      <select class="input" id="filter-ward" onchange="renderTable()">
        <option value="">All Wards</option>
      </select>
      <select class="input" id="filter-cond" onchange="renderTable()">
        <option value="">All Conditions</option>
        <option>Stable</option><option>Critical</option><option>Recovering</option>
        <option>Observation</option><option>Post-Surgery</option><option>Monitoring</option>
      </select>
    </div>

    <div class="section">
      <div class="section-header">
        <div class="section-title">ğŸ‘¥ Admissions <span id="count" style="color:var(--silver);font-size:13px;font-weight:400"></span></div>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>ID</th><th>Name</th><th>Age</th><th>Ward</th>
              <th>Bed</th><th>Condition</th><th>Doctor</th><th>Admitted</th>
              <th id="action-header"></th>
            </tr>
          </thead>
          <tbody id="patients-body"></tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Add Patient Modal -->
  <div class="modal-overlay" id="add-modal">
    <div class="modal">
      <h3>ğŸ¥ Admit New Patient</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
        <div>
          <label style="font-size:11px;color:var(--silver);text-transform:uppercase;letter-spacing:.05em;display:block;margin-bottom:5px">Full Name</label>
          <input class="input" id="m-name" placeholder="e.g. John Smith" style="width:100%">
        </div>
        <div>
          <label style="font-size:11px;color:var(--silver);text-transform:uppercase;letter-spacing:.05em;display:block;margin-bottom:5px">Age</label>
          <input class="input" type="number" id="m-age" placeholder="Age" style="width:100%">
        </div>
        <div>
          <label style="font-size:11px;color:var(--silver);text-transform:uppercase;letter-spacing:.05em;display:block;margin-bottom:5px">Ward</label>
          <select class="input" id="m-ward" style="width:100%"></select>
        </div>
        <div>
          <label style="font-size:11px;color:var(--silver);text-transform:uppercase;letter-spacing:.05em;display:block;margin-bottom:5px">Condition</label>
          <select class="input" id="m-cond" style="width:100%">
            <option>Stable</option><option>Critical</option><option>Recovering</option>
            <option>Observation</option><option>Post-Surgery</option><option>Monitoring</option>
          </select>
        </div>
        <div>
          <label style="font-size:11px;color:var(--silver);text-transform:uppercase;letter-spacing:.05em;display:block;margin-bottom:5px">Doctor</label>
          <select class="input" id="m-doc" style="width:100%">
            <option>Dr. Patel</option><option>Dr. Kim</option><option>Dr. Rodriguez</option><option>Dr. Hassan</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="admitPatient()">Admit Patient</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const user = getUser();
    document.getElementById('user-name').textContent = user.username;
    document.getElementById('user-avatar').textContent = user.username[0].toUpperCase();
    const isAdmin = user.role === 'admin';

    if(isAdmin) {
      document.getElementById('nav-home').href = 'admin.html';
      document.getElementById('nav-beds').href = 'beds.html';
      document.getElementById('panel-label').textContent = 'Admin Control Panel';
      document.getElementById('user-role-label').textContent = 'Administrator';
      document.getElementById('admin-actions').style.display = 'flex';
      document.getElementById('action-header').textContent = 'Actions';
    } else {
      document.getElementById('nav-home').href = 'dashboard.html';
      document.getElementById('nav-beds').href = '#';
      document.getElementById('admin-links').style.display = 'none';
      document.getElementById('panel-label').textContent = 'Staff Portal';
      document.getElementById('user-role-label').textContent = 'Staff / Viewer';
    }

    let state = getState();

    // Populate ward filter
    const fw = document.getElementById('filter-ward');
    WARDS.forEach(w=>{ const o=document.createElement('option'); o.value=w.id; o.textContent=w.name; fw.appendChild(o); });

    // Populate modal ward
    const mw = document.getElementById('m-ward');
    WARDS.forEach(w=>{ const o=document.createElement('option'); o.value=w.id; o.textContent=w.name; mw.appendChild(o); });

    const condColors = { Stable:'var(--emerald)', Critical:'var(--red)', Recovering:'var(--blue-l)', Observation:'var(--amber)', 'Post-Surgery':'var(--purple)', Monitoring:'var(--teal)' };

    function renderTable() {
      const q = document.getElementById('search').value.toLowerCase();
      const fw2 = document.getElementById('filter-ward').value;
      const fc = document.getElementById('filter-cond').value;
      const filtered = state.patients.filter(p=>{
        const wName = WARDS.find(w=>w.id===p.ward)?.name||p.ward;
        return (!q || p.name.toLowerCase().includes(q) || p.id.toLowerCase().includes(q)) &&
               (!fw2 || p.ward===fw2) && (!fc || p.condition===fc);
      });
      document.getElementById('count').textContent = `(${filtered.length})`;
      document.getElementById('patients-body').innerHTML = filtered.map(p=>{
        const wName = WARDS.find(w=>w.id===p.ward)?.name||p.ward;
        const c = condColors[p.condition]||'var(--silver)';
        const actionCell = isAdmin ? `
          <td>
            <button class="btn btn-danger" style="padding:4px 10px;font-size:11px" onclick="discharge('${p.id}')">Discharge</button>
          </td>` : '<td></td>';
        return `<tr>
          <td style="font-family:monospace;color:var(--silver)">${p.id}</td>
          <td style="font-weight:600">${p.name}</td>
          <td>${p.age}</td>
          <td>${wName}</td>
          <td>${p.bed}</td>
          <td><span class="condition-badge" style="background:${c}22;color:${c}">${p.condition}</span></td>
          <td style="color:var(--silver)">${p.doctor}</td>
          <td style="color:var(--silver)">${p.admitted}</td>
          ${actionCell}
        </tr>`;
      }).join('');
    }

    function discharge(id) {
      if(!confirm('Discharge patient '+id+'?')) return;
      const idx = state.patients.findIndex(p=>p.id===id);
      if(idx>-1){
        const ward = state.patients[idx].ward;
        state.patients.splice(idx,1);
        state.beds[ward].occupied = Math.max(0, state.beds[ward].occupied - 1);
        saveState(state);
        renderTable();
        showToast('âœ… Patient discharged','success');
      }
    }

    function openAddModal() { document.getElementById('add-modal').classList.add('open'); }
    function closeModal() { document.getElementById('add-modal').classList.remove('open'); }

    function admitPatient() {
      const name = document.getElementById('m-name').value.trim();
      const age = parseInt(document.getElementById('m-age').value)||0;
      if(!name||!age){ showToast('Please fill all fields','error'); return; }
      const ward = document.getElementById('m-ward').value;
      const avail = state.beds[ward].total - state.beds[ward].occupied - state.beds[ward].maintenance;
      if(avail<=0){ showToast('No beds available in this ward!','error'); return; }
      const newId = 'PT' + String(1000 + state.patients.length).slice(1);
      state.patients.unshift({
        id: newId,
        name, age, ward,
        bed: state.beds[ward].occupied + 1,
        admitted: new Date().toLocaleDateString(),
        condition: document.getElementById('m-cond').value,
        doctor: document.getElementById('m-doc').value,
      });
      state.beds[ward].occupied++;
      saveState(state);
      closeModal();
      renderTable();
      showToast('âœ… Patient admitted as '+newId,'success');
    }

    function showToast(msg,type='success') {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.className = `toast ${type} show`;
      setTimeout(()=>t.classList.remove('show'),3000);
    }

    renderTable();
  </script>
</body>
</html>
