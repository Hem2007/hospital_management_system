<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Predictions â€” MediTrack</title>
  <link rel="stylesheet" href="../css/dashboard.css">
  <script src="../js/data.js"></script>
</head>
<body>
  <aside class="sidebar">
    <div class="sidebar-logo">
      <div class="logo-icon">ğŸ¥</div>
      <h2>MediTrack</h2>
      <p id="panel-label">Control Panel</p>
    </div>
    <div class="nav-section">
      <div class="nav-label">Main</div>
      <a class="nav-item" id="nav-home"><span class="icon">ğŸ“Š</span> Dashboard</a>
      <a class="nav-item" id="nav-beds"><span class="icon">ğŸ›ï¸</span> Bed Management</a>
      <a class="nav-item" href="patients.html"><span class="icon">ğŸ‘¥</span> Patients</a>
      <a class="nav-item active" href="prediction.html"><span class="icon">ğŸ“ˆ</span> Predictions</a>
    </div>
    <div class="nav-section" id="admin-links">
      <div class="nav-label">Admin</div>
      <a class="nav-item" href="manage-users.html"><span class="icon">ğŸ”§</span> Manage Users</a>
      <a class="nav-item" href="reports.html"><span class="icon">ğŸ“‹</span> Reports</a>
      <a class="nav-item" href="alerts.html"><span class="icon">ğŸ””</span> Alerts</a>
    </div>
    <div class="sidebar-footer">
      <div class="user-chip">
        <div class="user-avatar" id="user-avatar">U</div>
        <div class="user-info">
          <div class="user-name" id="user-name">User</div>
          <div class="user-role" id="user-role-label">Staff</div>
        </div>
        <button class="logout-btn" onclick="logout()">â»</button>
      </div>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div>
        <h1>Bed Availability Predictions</h1>
        <div class="subtitle">AI-powered 7-day forecast for each ward</div>
      </div>
      <div class="topbar-actions">
        <select class="input" id="forecast-days" onchange="renderAll()">
          <option value="7">7-Day Forecast</option>
          <option value="14">14-Day Forecast</option>
        </select>
      </div>
    </div>

    <!-- Overall prediction summary -->
    <div class="cards-grid" id="pred-summary"></div>

    <!-- Ward selector -->
    <div class="section" style="margin-bottom:24px">
      <div class="section-header">
        <div class="section-title">ğŸ“Š Ward-by-Ward Forecast</div>
      </div>
      <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:20px" id="ward-tabs"></div>
      <div id="forecast-chart-area"></div>
    </div>

    <!-- All wards prediction table -->
    <div class="section">
      <div class="section-header">
        <div class="section-title">ğŸ“‹ 7-Day Prediction Table â€” All Wards</div>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Ward</th>
              <th>Today</th>
              <th>Day 1</th>
              <th>Day 2</th>
              <th>Day 3</th>
              <th>Day 4</th>
              <th>Day 5</th>
              <th>Day 6</th>
              <th>Day 7</th>
              <th>Risk Level</th>
            </tr>
          </thead>
          <tbody id="pred-table"></tbody>
        </table>
      </div>
    </div>
  </main>

  <script>
    const user = getUser();
    document.getElementById('user-name').textContent = user.username;
    document.getElementById('user-avatar').textContent = user.username[0].toUpperCase();
    if(user.role === 'admin') {
      document.getElementById('nav-home').href = 'admin.html';
      document.getElementById('nav-beds').href = 'beds.html';
      document.getElementById('panel-label').textContent = 'Admin Control Panel';
      document.getElementById('user-role-label').textContent = 'Administrator';
    } else {
      document.getElementById('nav-home').href = 'dashboard.html';
      document.getElementById('nav-beds').href = '#';
      document.getElementById('admin-links').style.display = 'none';
      document.getElementById('panel-label').textContent = 'Staff Portal';
      document.getElementById('user-role-label').textContent = 'Staff / Viewer';
    }

    const state = getState();
    let selectedWard = WARDS[0].id;

    function getRiskLevel(rate) {
      if(rate>=90) return {label:'Critical',color:'var(--red)'};
      if(rate>=75) return {label:'High',color:'var(--amber)'};
      if(rate>=60) return {label:'Moderate',color:'var(--blue-l)'};
      return {label:'Low',color:'var(--emerald)'};
    }

    function renderSummary() {
      const summaries = WARDS.map(w=>{
        const preds = predict(w.id, 7);
        const maxRate = Math.max(...preds.map(p=>p.rate));
        const risk = getRiskLevel(maxRate);
        return {w, preds, maxRate, risk};
      });
      const critCount = summaries.filter(s=>s.maxRate>=90).length;
      const highCount = summaries.filter(s=>s.maxRate>=75&&s.maxRate<90).length;
      document.getElementById('pred-summary').innerHTML = [
        {label:'Wards Monitored',value:WARDS.length,icon:'ğŸ¥',color:'var(--blue-l)'},
        {label:'Critical Risk (7d)',value:critCount,icon:'ğŸ”´',color:'var(--red)'},
        {label:'High Risk (7d)',value:highCount,icon:'ğŸŸ¡',color:'var(--amber)'},
        {label:'Avg Forecast Rate',value:Math.round(summaries.reduce((a,s)=>a+s.maxRate,0)/summaries.length)+'%',icon:'ğŸ“Š',color:'var(--teal)'},
      ].map(s=>`
        <div class="stat-card">
          <div class="sc-label">${s.icon} ${s.label}</div>
          <div class="sc-value" style="color:${s.color}">${s.value}</div>
        </div>
      `).join('');
    }

    function renderWardTabs() {
      document.getElementById('ward-tabs').innerHTML = WARDS.map(w=>`
        <button onclick="selectedWard='${w.id}';renderWardTabs();renderChart()" 
          style="padding:8px 16px;border-radius:8px;font-size:13px;font-weight:500;
          cursor:pointer;border:1px solid ${selectedWard===w.id?'var(--blue-l)':'var(--border)'};
          background:${selectedWard===w.id?'rgba(26,86,219,0.2)':'var(--card)'};
          color:${selectedWard===w.id?'var(--blue-l)':'var(--silver)'};
          font-family:DM Sans,sans-serif;transition:all .15s">
          ${w.icon} ${w.name}
        </button>
      `).join('');
    }

    function renderChart() {
      const days = parseInt(document.getElementById('forecast-days').value);
      const preds = predict(selectedWard, days);
      const ward = WARDS.find(w=>w.id===selectedWard);
      const maxOcc = Math.max(...preds.map(p=>p.predicted));
      const area = document.getElementById('forecast-chart-area');

      // SVG bar chart
      const w = 700, h = 220, padL=40, padB=30, padT=20, padR=20;
      const chartW = w - padL - padR;
      const chartH = h - padT - padB;
      const barW = Math.floor(chartW / preds.length) - 4;

      let bars = '', labels = '', lines = '';
      preds.forEach((p,i)=>{
        const x = padL + i*(chartW/preds.length) + 2;
        const barH = (p.predicted / ward.total) * chartH;
        const y = padT + chartH - barH;
        const color = p.rate>=90?'#ef4444':p.rate>=75?'#f59e0b':p.rate>=60?'#3b82f6':'#10b981';
        bars += `<rect x="${x}" y="${y}" width="${barW}" height="${barH}" rx="4" fill="${color}" opacity="0.8"/>`;
        bars += `<text x="${x+barW/2}" y="${y-6}" text-anchor="middle" fill="${color}" font-size="10" font-weight="600">${p.rate}%</text>`;
        labels += `<text x="${x+barW/2}" y="${h-10}" text-anchor="middle" fill="#94a3b8" font-size="9">${p.date}</text>`;
      });

      // Y-axis gridlines
      for(let pct=0;pct<=100;pct+=25){
        const y2 = padT + chartH - (pct/100)*chartH;
        lines += `<line x1="${padL}" y1="${y2}" x2="${w-padR}" y2="${y2}" stroke="rgba(255,255,255,0.05)" stroke-width="1"/>`;
        lines += `<text x="${padL-5}" y="${y2+4}" text-anchor="end" fill="#94a3b8" font-size="9">${pct}%</text>`;
      }

      area.innerHTML = `
        <div style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px">
          <div style="font-size:14px;font-weight:600;margin-bottom:16px;color:var(--white)">
            ${ward.icon} ${ward.name} â€” ${days}-Day Forecast 
            <span style="font-size:12px;color:var(--silver);margin-left:8px">(${ward.total} total beds)</span>
          </div>
          <svg viewBox="0 0 ${w} ${h}" style="width:100%;max-width:${w}px">
            ${lines}${bars}${labels}
          </svg>
          <div style="display:flex;gap:20px;margin-top:12px;font-size:11px">
            <span style="color:var(--emerald)">â–  Low (&lt;60%)</span>
            <span style="color:var(--blue-l)">â–  Moderate (60-74%)</span>
            <span style="color:var(--amber)">â–  High (75-89%)</span>
            <span style="color:var(--red)">â–  Critical (â‰¥90%)</span>
          </div>
        </div>
        <!-- Detail table for selected ward -->
        <div style="margin-top:16px;overflow-x:auto">
          <table>
            <thead><tr>
              <th>Date</th><th>Predicted Occupied</th><th>Available</th><th>Rate</th><th>Risk</th>
            </tr></thead>
            <tbody>
              ${preds.map(p=>{
                const avail = p.total - p.predicted;
                const risk = getRiskLevel(p.rate);
                return `<tr>
                  <td style="color:var(--silver)">${p.date}</td>
                  <td style="font-weight:600">${p.predicted} / ${p.total}</td>
                  <td style="color:var(--emerald)">${avail}</td>
                  <td>${p.rate}%</td>
                  <td><span class="condition-badge" style="background:${risk.color}22;color:${risk.color}">${risk.label}</span></td>
                </tr>`;
              }).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    function renderPredTable() {
      const preds7 = WARDS.map(w=>({w, preds:predict(w.id,7)}));
      document.getElementById('pred-table').innerHTML = preds7.map(({w,preds})=>{
        const b = state.beds[w.id];
        const currRate = Math.round((b.occupied/b.total)*100);
        const maxRate = Math.max(...preds.map(p=>p.rate));
        const risk = getRiskLevel(maxRate);
        return `<tr>
          <td><b>${w.icon} ${w.name}</b></td>
          <td style="color:${currRate>=90?'var(--red)':currRate>=75?'var(--amber)':'var(--emerald)'}">${currRate}%</td>
          ${preds.map(p=>{
            const c = p.rate>=90?'var(--red)':p.rate>=75?'var(--amber)':p.rate>=60?'var(--blue-l)':'var(--emerald)';
            return `<td style="color:${c};font-weight:500">${p.rate}%</td>`;
          }).join('')}
          <td><span class="condition-badge" style="background:${risk.color}22;color:${risk.color}">${risk.label}</span></td>
        </tr>`;
      }).join('');
    }

    function renderAll() {
      renderSummary(); renderWardTabs(); renderChart(); renderPredTable();
    }

    renderAll();
  </script>
</body>
</html>
